name: Update tags

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Update tags
        id: gentags
        shell: pwsh
        run: ./.github/deps/update-tags.ps1

      - name: Create Pull Request
        id: cpr
        if: steps.gentags.outputs.changed == 'True'
        uses: peter-evans/create-pull-request@v4
        with:
          commit-message: Updated pages
          signoff: true
          branch: page-update
          delete-branch: true
          committer: GitHub <noreply@github.com>
          author: GitHub <noreply@github.com>
          title: 'Update pages'
          body: |
            Hey there!

            It seems that your pages need to be updated.
            I went ahead and updated your page files for you. :wink:

            Added tags: ${{ steps.gentags.outputs.new-tags }}
            Deleted tags: ${{ steps.gentags.outputs.deleted-tags }}

            Added categories: ${{ steps.gentags.outputs.new-categories }}
            Deleted categories: ${{ steps.gentags.outputs.deleted-categories }}

            Added author: ${{ steps.gentags.outputs.new-author }}
            Deleted author: ${{ steps.gentags.outputs.deleted-author }}

            **_[ This was automatically generated by github-actions[bot] ]_**
          draft: false

      - name: Enable Pull Request Automerge
        if: steps.gentags.outputs.changed == 'True'
        uses: peter-evans/enable-pull-request-automerge@v2
        with:
          token: ${{ secrets.REPO_SCOPED_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: rebase

      - name: Auto approve
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: juliangruber/approve-pull-request-action@v1
        with:
          github-token: ${{ secrets.REPO_SCOPED_TOKEN }}
          number: ${{ steps.cpr.outputs.pull-request-number }}
