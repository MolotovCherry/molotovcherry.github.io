<!doctype html><html lang="en-US" data-theme="dark" data-preload><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Rust and Telegram Bots | Cherry‚Äôs Digital Space üçí</title><meta name="generator" content="Jekyll v4.2.2"><meta property="og:title" content="Rust and Telegram Bots"><meta name="author" content="MolotovCherry"><meta property="og:locale" content="en_US"><meta name="description" content="&lt;!DOCTYPE html PUBLIC ‚Äú-//W3C//DTD HTML 4.0 Transitional//EN‚Äù ‚Äúhttp://www.w3.org/TR/REC-html40/loose.dtd‚Äù&gt; Recently I‚Äôve been having a fun time trying my hand out with telegram and their bot api. I found a wonderful telegram bot library for Rust called teloxide. Since I can‚Äôt seem to find any good ways to get notified about which anime or manga are on my currently reading lists, I decided to make a bot that will notify me when new shows/chapters come out. This was quite the fascinating adventure!"><meta property="og:description" content="&lt;!DOCTYPE html PUBLIC ‚Äú-//W3C//DTD HTML 4.0 Transitional//EN‚Äù ‚Äúhttp://www.w3.org/TR/REC-html40/loose.dtd‚Äù&gt; Recently I‚Äôve been having a fun time trying my hand out with telegram and their bot api. I found a wonderful telegram bot library for Rust called teloxide. Since I can‚Äôt seem to find any good ways to get notified about which anime or manga are on my currently reading lists, I decided to make a bot that will notify me when new shows/chapters come out. This was quite the fascinating adventure!"><link rel="canonical" href="http://molotovcherry.github.io/programming/rust-and-telegram-bots"><meta property="og:url" content="http://molotovcherry.github.io/programming/rust-and-telegram-bots"><meta property="og:site_name" content="Cherry‚Äôs Digital Space üçí"><meta property="og:type" content="article"><meta property="article:published_time" content="2022-06-22T00:00:00+00:00"><meta name="twitter:card" content="summary"><meta property="twitter:title" content="Rust and Telegram Bots"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"MolotovCherry"},"dateModified":"2022-06-22T00:00:00+00:00","datePublished":"2022-06-22T00:00:00+00:00","description":"&lt;!DOCTYPE html PUBLIC ‚Äú-//W3C//DTD HTML 4.0 Transitional//EN‚Äù ‚Äúhttp://www.w3.org/TR/REC-html40/loose.dtd‚Äù&gt; Recently I‚Äôve been having a fun time trying my hand out with telegram and their bot api. I found a wonderful telegram bot library for Rust called teloxide. Since I can‚Äôt seem to find any good ways to get notified about which anime or manga are on my currently reading lists, I decided to make a bot that will notify me when new shows/chapters come out. This was quite the fascinating adventure!","headline":"Rust and Telegram Bots","mainEntityOfPage":{"@type":"WebPage","@id":"http://molotovcherry.github.io/programming/rust-and-telegram-bots"},"url":"http://molotovcherry.github.io/programming/rust-and-telegram-bots"}</script><link rel="stylesheet" href="/assets/css/style.css?v="><link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.ico"><noscript><link rel="stylesheet" href="/assets/css/noscript.css?v="></noscript><script src="/assets/js/immediate.js"></script><script src="/assets/js/deferred.js" defer></script><meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><script async src="https://www.googletagmanager.com/gtag/js?id=G-QY70XMH6JE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-QY70XMH6JE');</script></head><body onload="cherryblog.postSetup()"><div class="wrapper"><header><h1><a href="http://molotovcherry.github.io">Cherry's Digital Space üçí</a></h1><p>When all else fails ... reboot.</p><p class="view"> <a href="http://molotovcherry.github.io/archives">Archives</a> | <a href="http://molotovcherry.github.io/about">About</a> </p><input id="theme-switcher" class="theme-switcher" type="checkbox"></header><section><article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting"><header class="blog-title"><h1 class="post-title p-name" itemprop="name headline">Rust and Telegram Bots</h1><p class="post-meta"> <time class="dt-published" datetime="2022-06-22T00:00:00+00:00" itemprop="datePublished">Jun 22, 2022 </time> ‚Ä¢ by <div class="avatar-container"> <a href="https://github.com/molotovcherry" target="_blank"> <img class="avatar" alt="molotovcherry" width="100" height="100" data-proofer-ignore="true" src="https://avatars0.githubusercontent.com/molotovcherry?v=3&s=100" srcset="https://avatars0.githubusercontent.com/molotovcherry?v=3&s=100 1x, https://avatars0.githubusercontent.com/molotovcherry?v=3&s=200 2x, https://avatars0.githubusercontent.com/molotovcherry?v=3&s=300 3x, https://avatars0.githubusercontent.com/molotovcherry?v=3&s=400 4x" /> </a> </div> <a href="/author/molotovcherry/"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span class="p-author h-card" itemprop="name"> MolotovCherry </span> </span> </a> ‚Ä¢ <span><a href="/category/programming/">Programming</a></span>  </p><div class="bubble-container"><a class="bubble bubble-item" href="/tag/telegram/">telegram</a><a class="bubble bubble-item" href="/tag/bot/">bot</a><a class="bubble bubble-item" href="/tag/rust/">rust</a><a class="bubble bubble-item" href="/tag/teloxide/">teloxide</a><a class="bubble bubble-item" href="/tag/tokio/">tokio</a></div></header><div class="post-content e-content" itemprop="articleBody"><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><html><body><p>Recently I‚Äôve been having a fun time trying my hand out with telegram and their bot api. I found a wonderful telegram bot library for Rust called <a href="https://github.com/teloxide/teloxide">teloxide</a>.</p><p>Since I can‚Äôt seem to find any good ways to get notified about which anime or manga are on my currently reading lists, I decided to make a bot that will notify me when new shows/chapters come out. This was quite the fascinating adventure!</p><h2 id="tokio-and-dptree">Tokio and Dptree</h2><p>I started with the wonderful library known as <a href="https://github.com/tokio-rs/tokio">Tokio</a>, since using async is a great way to make the program more responsive when dealing with things like blocking io. Plus, tokio is useful since it handles putting things on new threads for you.</p><p>So, I started out with the typical main function that we all start with</p><div class="collapse-container"><button class="collapsible" onclick="toggleBlock(this)"><i class="lang-icon devicon-rust-plain"></i><div class="lang-label"> Rust</div></button><div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[tokio::main]</span>
<span class="k">async</span> <span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

<span class="p">}</span>
</code></pre></div></div></div><p>Seeing that teloxide is quite a handful to learn at first, it took a little bit to figure out, but anyhow, next we start with the actual dispatcher of course.</p><div class="collapse-container"><button class="collapsible" onclick="toggleBlock(this)"><i class="lang-icon devicon-rust-plain"></i><div class="lang-label"> Rust</div></button><div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[tokio::main]</span>
<span class="k">async</span> <span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nn">Dispatcher</span><span class="p">::</span><span class="nf">builder</span><span class="p">(</span><span class="n">bot</span><span class="p">,</span> <span class="nf">handler</span><span class="p">())</span>
        <span class="nf">.dependencies</span><span class="p">(</span><span class="nn">dptree</span><span class="p">::</span><span class="nd">deps!</span><span class="p">[</span><span class="nn">InMemStorage</span><span class="p">::</span><span class="o">&lt;</span><span class="n">State</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">new</span><span class="p">()])</span>
        <span class="nf">.build</span><span class="p">()</span>
        <span class="nf">.setup_ctrlc_handler</span><span class="p">()</span>
        <span class="nf">.dispatch</span><span class="p">()</span><span class="k">.await</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div></div><p>I played around with the handler function a bit, because I wanted a handler that can handle <a href="https://github.com/teloxide/teloxide/blob/master/examples/dialogue.rs">dialog</a> as well as regular messages. Since teloxide uses <a href="https://github.com/teloxide/dptree">dptree</a> which makes use of the <a href="https://en.wikipedia.org/wiki/Chain-of-responsibility_pattern">chain (tree) of responsibility</a> pattern, it is sometimes a bit difficult to wrap your head around the first time.</p><p>I ended up with this handler function.</p><div class="collapse-container"><button class="collapsible" onclick="toggleBlock(this)"><i class="lang-icon devicon-rust-plain"></i><div class="lang-label"> Rust</div></button><div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fn</span> <span class="nf">handler</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="n">Handler</span><span class="o">&lt;</span><span class="k">'static</span><span class="p">,</span> <span class="n">DependencyMap</span><span class="p">,</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span> <span class="n">Error</span> <span class="o">+</span> <span class="nb">Send</span> <span class="o">+</span> <span class="nb">Sync</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">DpHandlerDescription</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nn">dialogue</span><span class="p">::</span><span class="nn">enter</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Update</span><span class="p">,</span> <span class="n">InMemStorage</span><span class="o">&lt;</span><span class="n">State</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">_</span><span class="o">&gt;</span><span class="p">()</span>
        <span class="c1">// handle dialogs + commands</span>
        <span class="nf">.branch</span><span class="p">(</span><span class="nn">dialog</span><span class="p">::</span><span class="nf">schema</span><span class="p">())</span>
        <span class="c1">// handle remaining messages</span>
        <span class="nf">.branch</span><span class="p">(</span>
            <span class="nn">Update</span><span class="p">::</span><span class="nf">filter_message</span><span class="p">()</span>
                <span class="nf">.branch</span><span class="p">(</span>
                <span class="nn">dptree</span><span class="p">::</span><span class="nf">filter_async</span><span class="p">(</span>
                        <span class="p">|</span><span class="n">_bot</span><span class="p">:</span> <span class="nb">Arc</span><span class="o">&lt;</span><span class="n">AutoSend</span><span class="o">&lt;</span><span class="n">Bot</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">_msg</span><span class="p">:</span> <span class="n">Message</span><span class="p">|</span> <span class="p">{</span>
                            <span class="k">async</span> <span class="k">move</span> <span class="p">{</span>
                                <span class="c1">// don't handle any messages for now</span>
                                <span class="k">false</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">)</span><span class="nf">.endpoint</span><span class="p">(|</span><span class="n">_bot</span><span class="p">:</span> <span class="nb">Arc</span><span class="o">&lt;</span><span class="n">AutoSend</span><span class="o">&lt;</span><span class="n">Bot</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">_msg</span><span class="p">:</span> <span class="n">Message</span><span class="p">|</span> <span class="p">{</span>
                        <span class="k">async</span> <span class="p">{</span>
                            <span class="nf">Ok</span><span class="p">(())</span>
                        <span class="p">}</span>
                    <span class="p">})</span>
                <span class="p">)</span>
                <span class="nf">.branch</span><span class="p">(</span><span class="nn">dptree</span><span class="p">::</span><span class="nf">endpoint</span><span class="p">(</span><span class="nn">dialog</span><span class="p">::</span><span class="n">invalid_state</span><span class="p">))</span>
        <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div></div><p>So, seems cryptic right? Well, it probably is if you haven‚Äôt encountered it before at least. To put it in the way I understand it, dptree allows you to start with a beginning for processing <code class="language-plaintext highlighter-rouge">dptree::entry()</code>, and you can supply it with some kind of object to process, then you can add dependencies onto in the chain (dependency injection), and have additional self contained ‚Äúunits‚Äù of logic execution. <code class="language-plaintext highlighter-rouge">.branch</code> is similar to <code class="language-plaintext highlighter-rouge">.chain</code>, except that it receives the input from the last one. Anyways, I can‚Äôt say I still fully understand it myself yet, but I understand it enough to get what I need done.</p><p>In the example above, we pass the inputs into our dialog handler for processing, but then we also pass it to another branch which filters out the messages, chooses whether to handle them or not, and if not, lets execution continue to the last branch state, which we can make something like the bot sending <code class="language-plaintext highlighter-rouge">Sorry, I didn't catch waht you said</code>. Quite a useful pattern for bot messaging honestly.</p><h2 id="myanimelist-api">MyAnimeList API</h2><p>Anyhow, after making a nice dialog system according to the <a href="https://github.com/teloxide/teloxide/blob/master/examples/dialogue.rs">teloxide example</a>, I needed to interact with the <a href="https://myanimelist.net/apiconfig/references/api/v2">MAL api</a>. I didn‚Äôt find any real suitable Rust libraries for interacting with MAL, so I made my own from scratch using <a href="https://serde.rs/">serde</a>, <a href="https://github.com/seanmonstar/reqwest">reqwest</a>, and <a href="https://github.com/ramosbugs/oauth2-rs">oauth2</a>. Anyone who has used serde knows it‚Äôs not that difficult to use. Just provide some structs matching the api, for example:</p><div class="collapse-container"><button class="collapsible" onclick="toggleBlock(this)"><i class="lang-icon devicon-rust-plain"></i><div class="lang-label"> Rust</div></button><div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[derive(Deserialize,</span> <span class="nd">Serialize,</span> <span class="nd">Debug,</span> <span class="nd">IntoStaticStr,</span> <span class="nd">EnumString,</span> <span class="nd">Display,</span> <span class="nd">PartialEq,</span> <span class="nd">Clone)]</span>
<span class="nd">#[serde(rename_all</span> <span class="nd">=</span> <span class="s">"snake_case"</span><span class="nd">)]</span>
<span class="nd">#[strum(serialize_all</span> <span class="nd">=</span> <span class="s">"snake_case"</span><span class="nd">)]</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">WatchStatus</span> <span class="p">{</span>
    <span class="n">Watching</span><span class="p">,</span>
    <span class="n">Completed</span><span class="p">,</span>
    <span class="n">OnHold</span><span class="p">,</span>
    <span class="n">Dropped</span><span class="p">,</span>
    <span class="n">PlanToWatch</span>
<span class="p">}</span>
</code></pre></div></div></div><p>‚Ä¶ pretty easy stuff. Just match up the names the api returns json with. Since the api returns names in <code class="language-plaintext highlighter-rouge">snake_case</code>, I used serde‚Äôs <code class="language-plaintext highlighter-rouge">#[serde(rename_all = "snake_case")]</code> feature to keep the Rust PascalCase convention, while serializing to and deserializing from snake_case. Strum is there simply so we can work with the type easily in Rust.</p><p>When dealing with the <a href="https://myanimelist.net/apiconfig/references/authorization">MAL api‚Äôs oauth authentication</a>, you have to be <em>very careful</em> to do it properly, because it turns out that <code class="language-plaintext highlighter-rouge">code_challenge = code_verification</code>, which are typically not the same in oauth. If you don‚Äôt use the same challenge for both, you <strong>will fail</strong> authentication to the system.</p><div class="collapse-container"><button class="collapsible" onclick="toggleBlock(this)"><i class="lang-icon devicon-rust-plain"></i><div class="lang-label"> Rust</div></button><div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">self</span><span class="py">.client</span>
    <span class="c1">// authorization code is the `code` you receive from the api callback in MAL</span>
    <span class="nf">.exchange_code</span><span class="p">(</span><span class="nn">AuthorizationCode</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
    <span class="c1">// NOTE: MAL is using the code challenge's code as the code instead of verifier generated one</span>
    <span class="c1">// this is in fact the same one we used earlier when generating the oauth url</span>
    <span class="nf">.set_pkce_verifier</span><span class="p">(</span><span class="nn">PkceCodeVerifier</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">challenge_code</span><span class="p">))</span>
    <span class="nf">.request</span><span class="p">(</span><span class="n">http_client</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div></div></div><p>The api will then return to us an <code class="language-plaintext highlighter-rouge">access_token</code> and a <code class="language-plaintext highlighter-rouge">refresh_token</code>. Despite the MAL api saying the code is valid for 30 days, the access token is in fact valid for only one hour. However, the refresh token is valid for 30 days, so you can use that to keep asking for a new authorization token. If you do this before 30 days is up, you can hold onto the authorization indefinitely without having to ask the user to give authorization again. (See the <a href="https://github.com/ramosbugs/oauth2-rs/tree/main/examples">oauth examples</a> for more information on how to use their library).</p><p>Other than that, it‚Äôs as simple as using the standard way to call the <a href="https://myanimelist.net/apiconfig/references/api/v2">myanimelist api</a>. Provide your <code class="language-plaintext highlighter-rouge">acess_token</code> in the header just as the spec says, like so, <code class="language-plaintext highlighter-rouge">Authorization: Bearer {access_token}</code>.</p><h2 id="receiving-the-callback-from-mal">Receiving the Callback from MAL</h2><p>The astute reader might have noticed that I haven‚Äôt even mentioned how to receive the callback from MAL‚Äôs oauth. You see, you actually need a server URL for that. You can theoretically use your own home IP, forward your ports, run a web-server on it, but it‚Äôs honestly more pain than it‚Äôs worth, especially cause IP‚Äôs are dynamic. You <em>could</em> use a service like no-ip, but I digress.</p><p>So, how to do it? Well, I ended up going with Heroku, since they offer a nice free plan with like 550 free hours/month. Yes, the server shuts down after 30 minutes of inactivity, but this doesn‚Äôt matter much for our use-case. They have a stable URL, IP, you can use nearly ANY programming language you want on their server, AND you can deploy straight from GitHub (I‚Äôm not sponsored, I just love that they‚Äôre offering it for free).</p><p>So, I ended up writing a Rust server using <a href="https://github.com/actix/actix">actix</a> and <a href="https://github.com/actix/actix-web">actix-web</a>. By using the super nice <a href="https://github.com/emk/heroku-buildpack-rust">Rust buildpack</a> for Heroku, we can deploy an actual Rust server binary very easily (just set the URL to the buildpack in the heroku control panel), and as mentioned before, you can set up automatic deployment every time you push to GitHub.</p><p>You can follow the <a href="https://github.com/actix/actix-web/blob/master/actix-web/examples/basic.rs">actix-web</a> examples for how to use their library, but there is one thing I must address. That is, <em>our binary WON‚ÄôT START on heroku.</em> Why is that? First of all, you must understand two things: 1, heroku provides a specific port you must connect to, and this always changes. Easy enough, just read the <code class="language-plaintext highlighter-rouge">PORT</code> env var, and if not there, then use a default (for example, when testing the server locally). But 2, we most likely used <code class="language-plaintext highlighter-rouge">127.0.0.1</code> as the IP; seems reasonable, right? But it won‚Äôt work. Turns out the solution is to bind to <code class="language-plaintext highlighter-rouge">0.0.0.0</code>. From my understanding, this allows the IP to be set to whatever it needs to be set to (not sure how it works, but it does).</p><div class="collapse-container"><button class="collapsible" onclick="toggleBlock(this)"><i class="lang-icon devicon-rust-plain"></i><div class="lang-label"> Rust</div></button><div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[actix_web::main]</span>
<span class="k">async</span> <span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">std</span><span class="p">::</span><span class="nn">io</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// heroku uses PORT to tell server what port to start on</span>
    <span class="k">let</span> <span class="n">port</span> <span class="o">=</span> <span class="nn">env</span><span class="p">::</span><span class="nf">var</span><span class="p">(</span><span class="s">"PORT"</span><span class="p">)</span>
        <span class="nf">.unwrap_or_else</span><span class="p">(|</span><span class="n">_</span><span class="p">|</span> <span class="s">"8080"</span><span class="nf">.to_string</span><span class="p">())</span>
        <span class="py">.parse</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u16</span><span class="o">&gt;</span><span class="p">()</span>
        <span class="nf">.expect</span><span class="p">(</span><span class="s">"PORT must be a number"</span><span class="p">);</span>

    <span class="nn">HttpServer</span><span class="p">::</span><span class="nf">new</span><span class="p">(||</span> <span class="p">{</span>
        <span class="nn">App</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span>
            <span class="nf">.service</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
            <span class="nf">.service</span><span class="p">(</span><span class="n">websocket_client</span><span class="p">)</span>
            <span class="nf">.default_service</span><span class="p">(</span><span class="nn">web</span><span class="p">::</span><span class="nf">to</span><span class="p">(</span><span class="n">not_found</span><span class="p">))</span>
    <span class="p">})</span>
        <span class="c1">// 0.0.0.0 is require to work on heroku</span>
        <span class="nf">.bind</span><span class="p">((</span><span class="s">"0.0.0.0"</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span><span class="o">?</span>
        <span class="nf">.run</span><span class="p">()</span>
        <span class="k">.await</span>
<span class="p">}</span>
</code></pre></div></div></div><h2 id="using-the-server">Using the server</h2><p>Receiving the callback from MAL is easy enough. They provide 2 parameters according to oauth spec, which is <code class="language-plaintext highlighter-rouge">state</code> and <code class="language-plaintext highlighter-rouge">code</code>. Just receive these and you‚Äôre good to go.</p><div class="collapse-container"><button class="collapsible" onclick="toggleBlock(this)"><i class="lang-icon devicon-rust-plain"></i><div class="lang-label"> Rust</div></button><div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[derive(Deserialize,</span> <span class="nd">Debug,</span> <span class="nd">Clone)]</span>
<span class="k">struct</span> <span class="n">MalCallback</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">code</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">state</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>

<span class="nd">#[get(</span><span class="s">"/callback"</span><span class="nd">)]</span>
<span class="k">async</span> <span class="k">fn</span> <span class="nf">callback</span><span class="p">(</span><span class="n">callback</span><span class="p">:</span> <span class="nn">web</span><span class="p">::</span><span class="n">Query</span><span class="o">&lt;</span><span class="n">MalCallback</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">impl</span> <span class="n">Responder</span> <span class="p">{</span>
    <span class="c1">// do stuff</span>
<span class="p">}</span>
</code></pre></div></div></div><p>‚Ä¶ But what do we do with it? If you ever played with telegram bots, you‚Äôll have realized that your bot still runs locally. How will you get the code then?</p><p>For this, I used the built-in actix-web-actors, which has websocket support. Some examples for it are <a href="https://github.com/actix/examples/tree/master/websockets">here</a>.</p><p>We can make a websocket server on a url like <code class="language-plaintext highlighter-rouge">/client</code>, but make sure you authenticate the client with a jwt or something, since you should be the only one that receives the private callback information (though technically speaking, no one else still knows the code challenge you provided, so they‚Äôd still fail if they tried to use it). Because websockets has no custom headers, we can‚Äôt do something easily like pass an <code class="language-plaintext highlighter-rouge">Authorization</code> header. We have to implement our own protocol which asks for authorization, and have the client send it. If not, then disconnect the client since they‚Äôre not valid. Make sure you‚Äôre sending heartbeats to keep the client alive. Since this is a heroku service that only has so many hours, I decided to disconnect the client once it is done receiving the information, but you will want to make sure that the server saves and sends the info back to the client EVEN IF the client is not connected.. After all, you want to make sure it is robust.</p><p>Once I got that running, I turned to the <a href="https://github.com/snapview/tokio-tungstenite/">tokio-tungstenite</a> library for the client. Same thing, just follow your protocol and provide the authorization.</p><h2 id="getting-the-aired-episode-information">Getting the Aired episode information</h2><p>Turns out that MAL doesn‚Äôt have this info. However, Anilist does! Anilist apparently uses GraphQL instead. Their api docs are <a href="https://anilist.gitbook.io/anilist-apiv2-docs/">here</a>, but they have a wonderful <a href="https://anilist.co/graphiql">interactive GraphQL editor</a>. Thanks to anilist, they allow you to input  MAL ID to correlate it with the ID‚Äôs you get back from MAL. Perfect!</p><p>We can use a GraphQL query like this to get the latest airing episode info for a particular MAL ID. Using the data from this, you can correlate it with your current list and figure out when the next episode airs! Easy peasy!</p><div class="collapse-container"><button class="collapsible" onclick="toggleBlock(this)"><i class="lang-icon devicon-graphql-plain"></i><div class="lang-label"> Graphql</div></button><div class="language-graphql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">query</span><span class="w"> </span><span class="p">(</span><span class="nv">$type</span><span class="p">:</span><span class="w"> </span><span class="n">MediaType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">Media</span><span class="w"> </span><span class="p">(</span><span class="n">idMal</span><span class="p">:</span><span class="w"> </span><span class="err">&lt;</span><span class="n">YourID</span><span class="err">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="nv">$type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">idMal</span><span class="w">
    </span><span class="n">episodes</span><span class="w">
    </span><span class="n">nextAiringEpisode</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">episode</span><span class="w">
      </span><span class="n">airingAt</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div></div><h2 id="conclusion">Conclusion</h2><p>That‚Äôs actually pretty much it. The principle isn‚Äôt too difficult, if not more time consuming. But we made it! I apologize for big lack of code in this post, but my source code for the bot is private. Hope this post helps somebody though. :) If you have any questions, feel free to ask in the comments.</p><script>function toggleBlock(event) {event.classList.toggle("active");let content = event.nextElementSibling;if (content.style.maxHeight) {content.style.maxHeight = null;} else {content.style.maxHeight = content.scrollHeight + "px";}}</script></body></html><hr><style> #share-buttons {text-align:center; } #share-buttons > div {width: 32px; display:inline-block;} #share-buttons > div > svg {height: 16px; fill: #9d9d9d;} #share-buttons > div:hover {cursor: pointer;} #share-buttons > div.facebook:hover > svg {fill: #3B5998;} #share-buttons > div.twitter:hover > svg {fill: #55ACEE;} #share-buttons > div.linkedin:hover > svg {fill: #0077b5;} #share-buttons > div.gplus:hover > svg {fill: #dd4b39;} #share-buttons > div.mail:hover > svg {fill: #7D7D7D;} #share-buttons > div.instagram:hover > svg {fill: #C73B92;} #share-buttons > div.facebook > svg {height: 18px; vertical-align: middle;} #share-buttons > div.twitter > svg {height: 20px; vertical-align: middle;} #share-buttons > div.linkedin > svg {height: 19px; vertical-align: middle;} #share-buttons > div.pinterest > svg {height: 20px; vertical-align: middle;} #share-buttons > div.gplus > svg {height: 17px; margin-top: 9px; position: relative; left: 1px;} #share-buttons > div.mail > svg {height: 14px; vertical-align: middle;} </style><div id="share-buttons"><div class="facebook" title="Share this on Facebook"    onclick="window.open('http://www.facebook.com/share.php?u=http%3A%2F%2Fmolotovcherry.github.io%2Fprogramming%2Frust-and-telegram-bots','popup','width=600,height=600'); return false;"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
<path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg></div><div class="twitter"  title="Share this on Twitter"     onclick="window.open('https://twitter.com/intent/tweet?url=http%3A%2F%2Fmolotovcherry.github.io%2Fprogramming%2Frust-and-telegram-bots&text=Rust+and+Telegram+Bots&via=','popup','width=600,height=600'); return false;"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
<path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div><div class="linkedin" title="Share this on Linkedin"    onclick="window.open('https://www.linkedin.com/sharing/share-offsite/?url=http%3A%2F%2Fmolotovcherry.github.io%2Fprogramming%2Frust-and-telegram-bots','popup','width=600,height=600'); return false;"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
<path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg></div><div class="mail"     title="Share this through Email"  onclick="window.open('mailto:?&body=http%3A%2F%2Fmolotovcherry.github.io%2Fprogramming%2Frust-and-telegram-bots&subject=%5BBlog%5D+MolotovCherry+-+Rust+and+Telegram+Bots','popup','width=600,height=600'); return false;"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
<path d="M1792 710v794q0 66-47 113t-113 47h-1472q-66 0-113-47t-47-113v-794q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 100-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38-42.5-30.5q-91-64-262-182.5t-205-142.5q-62-42-117-115.5t-55-136.5q0-78 41.5-130t118.5-52h1472q65 0 112.5 47t47.5 113z"/></svg></div></div><div class="post_navi"><a class="post_navi-item nav_prev" href="/programming/jetbrains-is-awesome" title="JetBrains is Awesome"><div class="post_navi-arrow">&lt;</div><div class="post_navi-label">Previous Post</div><div><span>JetBrains is Awesome</span></div></a><a class="post_navi-item nav_next" href="http://molotovcherry.github.io/archive.html" title="Blog Archive"><div class="post_navi-arrow">&gt;</div><div class="post_navi-label">Blog Archive</div><div><span>Archive of all previous blog posts</span></div></a></div></div><a class="u-url" href="/programming/rust-and-telegram-bots" hidden></a><script>let script = document.createElement('script');script.src = "https://utteranc.es/client.js";script.setAttribute("repo", "molotovcherry/molotovcherry.github.io");script.setAttribute("issue-term", "pathname");script.setAttribute("label", "comments");script.setAttribute("theme", cherryblog.getCommentsTheme());script.setAttribute("crossorigin", "anonymous");script.async = true;document.currentScript.parentNode.appendChild(script);document.currentScript.remove();</script></article></section></div><footer><p><a rel="me" href="https://github.com/MolotovCherry" target="_blank" title="MolotovCherry"> <svg class="svg-icon grey" height="16px" width="16px"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="social-label">MolotovCherry</span></a></br></p></footer></body></html>
