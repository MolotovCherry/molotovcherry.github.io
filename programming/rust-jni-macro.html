<!doctype html><html lang="en-US" data-theme="dark" data-preload><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Rust JNI Macro | Cherry‚Äôs Digital Space üçí</title><meta name="generator" content="Jekyll v4.2.2"><meta property="og:title" content="Rust JNI Macro"><meta name="author" content="MolotovCherry"><meta property="og:locale" content="en_US"><meta name="description" content="&lt;!DOCTYPE html PUBLIC ‚Äú-//W3C//DTD HTML 4.0 Transitional//EN‚Äù ‚Äúhttp://www.w3.org/TR/REC-html40/loose.dtd‚Äù&gt; So, during the implementation of KMagick, I came up against a problem: With hundreds of functions all needing to be wrapped in JNI calls, how was I ever going to manage creating so much boilerplate code? This led to me working hard to research the Rust AST and syn in order to create a fully working macro which autogenerates JNI FFI calls from Rust code without any effort!"><meta property="og:description" content="&lt;!DOCTYPE html PUBLIC ‚Äú-//W3C//DTD HTML 4.0 Transitional//EN‚Äù ‚Äúhttp://www.w3.org/TR/REC-html40/loose.dtd‚Äù&gt; So, during the implementation of KMagick, I came up against a problem: With hundreds of functions all needing to be wrapped in JNI calls, how was I ever going to manage creating so much boilerplate code? This led to me working hard to research the Rust AST and syn in order to create a fully working macro which autogenerates JNI FFI calls from Rust code without any effort!"><link rel="canonical" href="http://molotovcherry.github.io/programming/rust-jni-macro"><meta property="og:url" content="http://molotovcherry.github.io/programming/rust-jni-macro"><meta property="og:site_name" content="Cherry‚Äôs Digital Space üçí"><meta property="og:type" content="article"><meta property="article:published_time" content="2022-03-05T00:00:00+00:00"><meta name="twitter:card" content="summary"><meta property="twitter:title" content="Rust JNI Macro"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"MolotovCherry"},"dateModified":"2022-03-05T00:00:00+00:00","datePublished":"2022-03-05T00:00:00+00:00","description":"&lt;!DOCTYPE html PUBLIC ‚Äú-//W3C//DTD HTML 4.0 Transitional//EN‚Äù ‚Äúhttp://www.w3.org/TR/REC-html40/loose.dtd‚Äù&gt; So, during the implementation of KMagick, I came up against a problem: With hundreds of functions all needing to be wrapped in JNI calls, how was I ever going to manage creating so much boilerplate code? This led to me working hard to research the Rust AST and syn in order to create a fully working macro which autogenerates JNI FFI calls from Rust code without any effort!","headline":"Rust JNI Macro","mainEntityOfPage":{"@type":"WebPage","@id":"http://molotovcherry.github.io/programming/rust-jni-macro"},"url":"http://molotovcherry.github.io/programming/rust-jni-macro"}</script><link rel="stylesheet" href="/assets/css/style.css?v="><link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.ico"><noscript><link rel="stylesheet" href="/assets/css/noscript.css?v="></noscript><script src="/assets/js/immediate.js"></script><script src="/assets/js/deferred.js" defer></script><meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><script async src="https://www.googletagmanager.com/gtag/js?id=G-QY70XMH6JE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-QY70XMH6JE');</script></head><body onload="cherryblog.postSetup()"><div class="wrapper"><header><h1><a href="http://molotovcherry.github.io">Cherry's Digital Space üçí</a></h1><p>When all else fails ... reboot.</p><p class="view"> <a href="http://molotovcherry.github.io/archives">Archives</a> | <a href="http://molotovcherry.github.io/about">About</a> </p><input id="theme-switcher" class="theme-switcher" type="checkbox"></header><section><article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting"><header class="blog-title"><h1 class="post-title p-name" itemprop="name headline">Rust JNI Macro</h1><p class="post-meta"> <time class="dt-published" datetime="2022-03-05T00:00:00+00:00" itemprop="datePublished">Mar 5, 2022 </time> ‚Ä¢ by <div class="avatar-container"> <a href="https://github.com/molotovcherry" target="_blank"> <img class="avatar" alt="molotovcherry" width="100" height="100" data-proofer-ignore="true" src="https://avatars0.githubusercontent.com/molotovcherry?v=3&s=100" srcset="https://avatars0.githubusercontent.com/molotovcherry?v=3&s=100 1x, https://avatars0.githubusercontent.com/molotovcherry?v=3&s=200 2x, https://avatars0.githubusercontent.com/molotovcherry?v=3&s=300 3x, https://avatars0.githubusercontent.com/molotovcherry?v=3&s=400 4x" /> </a> </div> <a href="/author/molotovcherry/"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span class="p-author h-card" itemprop="name"> MolotovCherry </span> </span> </a> ‚Ä¢ <span><a href="/category/programming/">Programming</a></span>  </p><div class="bubble-container"><a class="bubble bubble-item" href="/tag/rust/">rust</a><a class="bubble bubble-item" href="/tag/kmagick/">kmagick</a><a class="bubble bubble-item" href="/tag/jni/">jni</a><a class="bubble bubble-item" href="/tag/kotlin/">kotlin</a><a class="bubble bubble-item" href="/tag/proc-macro/">proc-macro</a><a class="bubble bubble-item" href="/tag/bindings/">bindings</a></div></header><div class="post-content e-content" itemprop="articleBody"><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><html><body><p>So, during the implementation of <a href="https://github.com/cherryleafroad/kmagick/">KMagick</a>, I came up against a problem: With hundreds of functions all needing to be wrapped in JNI calls, how was I ever going to manage creating so much boilerplate code?</p><p>This led to me working hard to research the Rust AST and <a href="https://crates.io/crates/syn">syn</a> in order to create a fully working macro which autogenerates JNI FFI calls from Rust code without any effort!</p><p>It handles idiomatic Rust code perfectly, allowing you to return <code class="language-plaintext highlighter-rouge">Result</code> types which, if they fail, will throw a native exception in Kotlin (rather than crashing). And, if for any reason the Rust code itself panics, it also will throw an exception in Kotlin rather than crashing the JVM (it achieves this using Rusts <a href="https://doc.rust-lang.org/std/panic/fn.catch_unwind.html">catch_unwind</a>).</p><p>I ended up with an interface like this, for functions</p><div class="collapse-container"><button class="collapsible" onclick="toggleBlock(this)"><i class="lang-icon devicon-rust-plain"></i><div class="lang-label"> Rust</div></button><div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[jmethod(cls=</span><span class="s">"some/java/cls"</span><span class="nd">,</span> <span class="nd">exc=</span><span class="s">"some/exception/ExcCls"</span><span class="nd">)]</span>
<span class="k">fn</span> <span class="nf">my_java_function</span><span class="p">(</span><span class="n">env</span><span class="p">:</span> <span class="n">JNIEnv</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">JObject</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">JNIResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">env</span><span class="nf">.do_something</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div></div></div><p>And it can even handle actual <code class="language-plaintext highlighter-rouge">impl</code>s AND keep state in-between calls using FFI magic (use a <code class="language-plaintext highlighter-rouge">var handle: Long? = null</code> on the Kotlin side to store the handle).</p><div class="collapse-container"><button class="collapsible" onclick="toggleBlock(this)"><i class="lang-icon devicon-rust-plain"></i><div class="lang-label"> Rust</div></button><div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">Foo</span> <span class="p">{</span>
    <span class="n">state</span><span class="p">:</span> <span class="nb">bool</span>
<span class="p">}</span>

<span class="nd">#[jclass(pkg=</span><span class="s">"some/java/pkg"</span><span class="nd">,</span> <span class="nd">exc=</span><span class="s">"some/exception/Cls"</span><span class="nd">)]</span>
<span class="k">impl</span> <span class="n">Foo</span> <span class="p">{</span>
    <span class="nd">#[jnew]</span>
    <span class="k">fn</span> <span class="nf">new</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">Self</span> <span class="p">{</span>
            <span class="n">state</span><span class="p">:</span> <span class="k">false</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">state_call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">JNIEnv</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">JObject</span><span class="p">,</span> <span class="n">new_state</span><span class="p">:</span> <span class="n">jboolean</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">JNIResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">// bubble up error to Kotlin</span>
        <span class="nf">some_rust_call</span><span class="p">(</span><span class="n">new_state</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

        <span class="c1">// as you can see, we have access to the old state in-between calls and can even change it</span>
        <span class="k">self</span><span class="py">.state</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">;</span>
        <span class="nf">Ok</span><span class="p">(())</span>
    <span class="p">}</span>

    <span class="nd">#[jstatic]</span>
    <span class="k">fn</span> <span class="nf">static_call</span><span class="p">(</span><span class="n">env</span><span class="p">:</span> <span class="n">JNIEnv</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">JObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// we can even make static calls</span>
    <span class="p">}</span>

    <span class="nd">#[jignore]</span>
    <span class="k">fn</span> <span class="nf">pure_rust_fn</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// and we can ignore a fn to stop it from being seen by JNI</span>
        <span class="k">self</span><span class="nf">.do_stuff</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">#[jname(name=</span><span class="s">"jni_sees_this_name"</span><span class="nd">)]</span>
    <span class="k">fn</span> <span class="nf">different_name</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">JNIEnv</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">JObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// or we can change the function name</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div></div><p>All in all, this allowed me to auto generate 1.7mb of JNI binding code while keeping all my Rust idiomatic! Lovely!</p><p>(If you‚Äôre curious what a generated function looks like‚Ä¶ It‚Äôs similar to this)</p><div class="collapse-container"><button class="collapsible" onclick="toggleBlock(this)"><i class="lang-icon devicon-rust-plain"></i><div class="lang-label"> Rust</div></button><div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">extern</span> <span class="s">"system"</span> <span class="k">fn</span> <span class="nf">Java_com_cherryleafroad_kmagick_Magick_magickQueryFonts</span><span class="p">(</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">JNIEnv</span><span class="p">,</span>
    <span class="n">GCNAyNEouE</span><span class="p">:</span> <span class="n">JObject</span><span class="p">,</span>
    <span class="n">pattern</span><span class="p">:</span> <span class="n">JString</span><span class="p">,</span>
<span class="p">)</span> <span class="k">-&gt;</span> <span class="n">jobjectArray</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">p_res</span> <span class="o">=</span> <span class="nn">std</span><span class="p">::</span><span class="nn">panic</span><span class="p">::</span><span class="nf">catch_unwind</span><span class="p">(||</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">c_res</span> <span class="o">=</span> <span class="nn">Magick</span><span class="p">::</span><span class="nf">magickQueryFonts</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">GCNAyNEouE</span><span class="p">,</span> <span class="n">pattern</span><span class="p">);</span>
        <span class="k">match</span> <span class="n">c_res</span> <span class="p">{</span>
            <span class="nf">Ok</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="n">v</span><span class="p">,</span>
            <span class="nf">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="k">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="nf">.throw_new</span><span class="p">(</span><span class="s">"com/cherryleafroad/kmagick/MagickException"</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
                <span class="nn">std</span><span class="p">::</span><span class="nn">ptr</span><span class="p">::</span><span class="nf">null_mut</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">match</span> <span class="n">p_res</span> <span class="p">{</span>
        <span class="nf">Ok</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="n">v</span><span class="p">,</span>
        <span class="nf">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">msg</span><span class="p">;</span>
            <span class="k">let</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="py">.downcast_ref</span><span class="p">::</span><span class="o">&lt;&amp;</span><span class="k">'static</span> <span class="nb">str</span><span class="o">&gt;</span><span class="p">();</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">=</span> <span class="n">e</span> <span class="p">{</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="nf">.throw_new</span><span class="p">(</span><span class="s">"java/lang/RuntimeException"</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
            <span class="nn">std</span><span class="p">::</span><span class="nn">ptr</span><span class="p">::</span><span class="nf">null_mut</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div></div><p>The macro is actually generalized and can be used by anyone. Check <a href="https://github.com/cherryleafroad/kmagick/tree/main/rust">here</a> if you‚Äôd like to know more.</p><script>function toggleBlock(event) {event.classList.toggle("active");let content = event.nextElementSibling;if (content.style.maxHeight) {content.style.maxHeight = null;} else {content.style.maxHeight = content.scrollHeight + "px";}}</script></body></html><hr><style> #share-buttons {text-align:center; } #share-buttons > div {width: 32px; display:inline-block;} #share-buttons > div > svg {height: 16px; fill: #9d9d9d;} #share-buttons > div:hover {cursor: pointer;} #share-buttons > div.facebook:hover > svg {fill: #3B5998;} #share-buttons > div.twitter:hover > svg {fill: #55ACEE;} #share-buttons > div.linkedin:hover > svg {fill: #0077b5;} #share-buttons > div.gplus:hover > svg {fill: #dd4b39;} #share-buttons > div.mail:hover > svg {fill: #7D7D7D;} #share-buttons > div.instagram:hover > svg {fill: #C73B92;} #share-buttons > div.facebook > svg {height: 18px; vertical-align: middle;} #share-buttons > div.twitter > svg {height: 20px; vertical-align: middle;} #share-buttons > div.linkedin > svg {height: 19px; vertical-align: middle;} #share-buttons > div.pinterest > svg {height: 20px; vertical-align: middle;} #share-buttons > div.gplus > svg {height: 17px; margin-top: 9px; position: relative; left: 1px;} #share-buttons > div.mail > svg {height: 14px; vertical-align: middle;} </style><div id="share-buttons"><div class="facebook" title="Share this on Facebook"    onclick="window.open('http://www.facebook.com/share.php?u=http%3A%2F%2Fmolotovcherry.github.io%2Fprogramming%2Frust-jni-macro','popup','width=600,height=600'); return false;"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
<path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg></div><div class="twitter"  title="Share this on Twitter"     onclick="window.open('https://twitter.com/intent/tweet?url=http%3A%2F%2Fmolotovcherry.github.io%2Fprogramming%2Frust-jni-macro&text=Rust+JNI+Macro&via=','popup','width=600,height=600'); return false;"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
<path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div><div class="linkedin" title="Share this on Linkedin"    onclick="window.open('https://www.linkedin.com/sharing/share-offsite/?url=http%3A%2F%2Fmolotovcherry.github.io%2Fprogramming%2Frust-jni-macro','popup','width=600,height=600'); return false;"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
<path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg></div><div class="mail"     title="Share this through Email"  onclick="window.open('mailto:?&body=http%3A%2F%2Fmolotovcherry.github.io%2Fprogramming%2Frust-jni-macro&subject=%5BBlog%5D+MolotovCherry+-+Rust+JNI+Macro','popup','width=600,height=600'); return false;"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
<path d="M1792 710v794q0 66-47 113t-113 47h-1472q-66 0-113-47t-47-113v-794q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 100-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38-42.5-30.5q-91-64-262-182.5t-205-142.5q-62-42-117-115.5t-55-136.5q0-78 41.5-130t118.5-52h1472q65 0 112.5 47t47.5 113z"/></svg></div></div><div class="post_navi"><a class="post_navi-item nav_prev" href="/programming/killing-annoying-processes-in-windows" title="Killing Annoying Processes in Windows"><div class="post_navi-arrow">&lt;</div><div class="post_navi-label">Previous Post</div><div><span>Killing Annoying Processes in Windows</span></div></a><a class="post_navi-item nav_next" href="/programming/jetbrains-is-awesome" title="JetBrains is Awesome"><div class="post_navi-arrow">&gt;</div><div class="post_navi-label">Next Post</div><div><span>JetBrains is Awesome</span></div></a></div></div><a class="u-url" href="/programming/rust-jni-macro" hidden></a><script>let script = document.createElement('script');script.src = "https://utteranc.es/client.js";script.setAttribute("repo", "molotovcherry/molotovcherry.github.io");script.setAttribute("issue-term", "pathname");script.setAttribute("label", "comments");script.setAttribute("theme", cherryblog.getCommentsTheme());script.setAttribute("crossorigin", "anonymous");script.async = true;document.currentScript.parentNode.appendChild(script);document.currentScript.remove();</script></article></section></div><footer><p><a rel="me" href="https://github.com/MolotovCherry" target="_blank" title="MolotovCherry"> <svg class="svg-icon grey" height="16px" width="16px"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="social-label">MolotovCherry</span></a></br></p></footer></body></html>
